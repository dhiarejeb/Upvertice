<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Manage Supplier Offers</h2>
    <button class="btn btn-primary" (click)="openCreateForm()">
      <i class="fa fa-plus"></i> New Offer
    </button>
  </div>

  <table class="table table-hover">
    <thead class="table-light">
    <tr>
      <th>Title</th>
      <th>Price</th>
      <th>Status</th>
      <th>Dates</th>
      <th>Image</th>
      <th>Sponsor Ads</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let offer of supplierOffers">
      <td>{{ offer.title }}</td>
      <td>{{ offer.price }} TND</td>
      <td><span class="badge bg-info text-dark">{{ offer.status }}</span></td>
      <td>{{ offer.startDate }} → {{ offer.endDate }}</td>
      <td>
        <img *ngIf="offer.imageUrl" [src]="offer.imageUrl" alt="Offer Image" class="img-thumbnail" width="60">
      </td>
      <td>
        <ng-container *ngIf="offer.sponsorAds?.length; else noAds">
    <span
      *ngFor="let ad of offer.sponsorAds"
      class="badge bg-secondary me-1"
      title="{{ ad.title }}">
      {{ ad.title!.length > 15 ? (ad.title | slice:0:15) + '…' : ad.title }}
    </span>
        </ng-container>
        <ng-template #noAds>
          <span class="text-muted">No Ads</span>
        </ng-template>
      </td>

      <td>
        <button class="btn btn-sm btn-warning me-1" (click)="editOffer(offer)">
          <i class="fa fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" (click)="confirmDelete(offer.id!)">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    </tr>
    </tbody>
  </table>


  <!-- Pagination -->
  <nav *ngIf="totalPages > 1" aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 0">
        <a class="page-link" (click)="changePage(-1)">Previous</a>
      </li>

      <li
        class="page-item"
        *ngFor="let i of [].constructor(totalPages); let index = index"
        [class.active]="index === currentPage">
        <a class="page-link" (click)="changePage(index - currentPage)">{{ index + 1 }}</a>
      </li>

      <li class="page-item" [class.disabled]="currentPage + 1 >= totalPages">
        <a class="page-link" (click)="changePage(1)">Next</a>
      </li>
    </ul>
  </nav>


  <!-- Create/Update Modal -->
  <div *ngIf="formVisible" class="modal show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">{{ editing ? 'Edit Offer' : 'Create Offer' }}</h5>
          <button type="button" class="btn-close" (click)="closeForm()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="onSubmit()" [formGroup]="offerForm">
            <div class="row g-2">
              <div class="col-md-6">
                <label>Title</label>
                <input formControlName="title" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label>Price (TND)</label>
                <input type="number" formControlName="price" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label>Quantity</label>
                <input type="number" formControlName="quantityAvailable" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label>Status</label>
                <select formControlName="status" class="form-select">
                  <option value="COMING_SOON">Coming Soon</option>
                  <option value="AVAILABLE">Available</option>
                  <option value="CLOSED">Closed</option>
                </select>
              </div>
              <div class="col-md-6">
                <label>Start Date</label>
                <input type="date" formControlName="startDate" class="form-control">
              </div>
              <div class="col-md-6">
                <label>End Date</label>
                <input type="date" formControlName="endDate" class="form-control">
              </div>
              <div class="col-12">
                <label>Description</label>
                <textarea formControlName="description" class="form-control"></textarea>
              </div>
              <div class="col-12">
                <label>Image</label>
                <input type="file" (change)="onImageSelected($event)" class="form-control">
              </div>
            </div>
            <div class="text-end mt-3">
              <button type="submit" class="btn btn-success">
                <i class="fa fa-save"></i> {{ editing ? 'Update' : 'Create' }}
              </button>
              <button type="button" class="btn btn-secondary ms-2" (click)="closeForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
